---
title: å›¾åƒ
author: ç†Šæ»”
commentid: canvas:image
---

## drawImage

é€šè¿‡ `drawImage()` æ–¹æ³•å¯ä»¥åœ¨ ***Canvas*** ä¸Šç»˜åˆ¶å›¾åƒï¼Œ `drawImage()` æœ‰ä¸‰ç§ç”¨æ³•

- `drawImage(img, x, y)`
- `drawImage(img, x, y, w, h)`
- `drawImage(img, sx, sy, sw, sh, x, y, w, h)`

å…ˆä»‹ç» `drawImage(img, x, y)` ï¼Œå…¶ä¸­ `img` ä¸º `HTMLImageElement` å¯¹è±¡æˆ–è€… ***Canvas*** å¯¹è±¡ï¼Œ`(x, y)` è¡¨ç¤ºå›¾åƒ**å·¦ä¸Šè§’**åœ¨ ***Canvas*** ä¸­çš„åæ ‡

<ImageView src="https://cdn.jsdelivr.net/gh/LastKnightCoder/ImgHosting3@master/car.i5wyhci5g6w.jpeg" alt="car.jpeg" style="zoom:50%;" />

```js
const img = new Image()
img.addEventListener('load', () => {
  ctx.drawImage(img, 0, 0)
})
img.src = './car.jpeg'
```

<iframe src="https://lastknightcoder.github.io/canvas-demos/44.html" height="510" width="100%"></iframe>

ä¸Šé¢æˆ‘ä»¬å°†ä¸€ä¸ª $2800 \times 1574$  çš„å›¾ç‰‡æ”¾åœ¨äº† $700 \times 500$ çš„ ***Canvas*** ä¸­ï¼Œå›¾åƒçš„èµ·ç‚¹ä¸º `(0, 0)`ï¼Œå›¾ç‰‡åªæ˜¾ç¤ºäº†ä¸€éƒ¨åˆ†ï¼Œå¦‚æœæˆ‘ä»¬å¸Œæœ›å…¨éƒ¨æ˜¾ç¤ºå›¾ç‰‡å°±å¾—æŒ‡å®šå›¾ç‰‡çš„å¤§å°ï¼Œè¿™ä¸ªæ—¶å€™å°±å¾—ä½¿ç”¨ `drawImage(img, x, y, w, h)` ï¼Œå…¶ä¸­æ–°å¢çš„ `w` å’Œ `h` è¡¨ç¤ºæ”¾ç½®åœ¨ ***Canvas*** ä¸­å›¾ç‰‡çš„å¤§å°

```js
const img = new Image()
img.addEventListener('load', () => {
  const width = img.width
  const height = img.height
  const ratio = width / height;

  ctx.drawImage(img, 0, 0, 700, 700 / ratio)
})
img.src = './car.jpeg'
```

<iframe src="https://lastknightcoder.github.io/canvas-demos/45.html" height="410" width="100%"></iframe>

`drawImage(img, sx, sy, sw, sh, x, y, w, h)` çš„æœ€åä¸€ç§ç”¨æ³•ä¸è£å‰ªæœ‰å…³ï¼Œå…¶ä¸­ `(sx, sy)` è¡¨ç¤ºè£å‰ªçš„èµ·ç‚¹ï¼Œ`sw` ä¸ `sh` è¡¨ç¤ºè£å‰ªçš„åŒºåŸŸï¼Œæ¥ç€å°†è£å‰ªåçš„å›¾ç‰‡æ”¾ç½®åœ¨èµ·ç‚¹ä¸º `(x, y)` å¤„ï¼Œå¹¶è®¾ç½®å…¶å¤§å° `w` å’Œ `h` ï¼Œä¸¾ä¸ªğŸŒ°

```js
drawImage(img, 100, 100, 100, 100, 0, 0, 200, 200)
```

é¦–å…ˆè£å‰ªå›¾ç‰‡ `img` èµ·ç‚¹ä¸º `(100, 100)`ï¼Œå¤§å°ä¸º $100 \times 100$ çš„åŒºåŸŸï¼Œæ¥ç€å°†è£å‰ªå¾—åˆ°çš„å›¾åƒæ”¾åœ¨èµ·ç‚¹ä¸º `(0, 0)`ï¼Œå¤§å°ä¸º $200 \times 200$ çš„åŒºåŸŸä¸­ã€‚

å¯¹äºä¸Šé¢é‚£å‰¯  $2800 \times 1574$  çš„å›¾åƒï¼Œæˆ‘æƒ³è£å‰ªå®ƒå³ä¸Šè§’é‚£å››åˆ†ä¹‹ä¸€çš„åŒºåŸŸï¼Œç„¶åå°†å…¶æ”¾åœ¨ ***Canvas*** çš„ä¸Šéƒ¨åˆ†åŒºåŸŸï¼Œä»£ç å¦‚ä¸‹ç¼–å†™

```js
const img = new Image()
img.addEventListener('load', () => {
  const width = img.width
  const height = img.height
  const ratio = width / height;

  // æºå›¾åƒå³ä¸Šè§’çš„èµ·ç‚¹ä¸º (1400, 0)ï¼Œå¤§å°ä¸º (1400, 1400 / ratio)
  // Canvasä¸Šéƒ¨åˆ†çš„èµ·ç‚¹ä¸º (0, 0)ï¼Œè¦ç­‰æ¯”æ”¾ä¸‹å›¾ç‰‡ï¼Œåˆ™å…¶å¤§å°è®¾ç½®ä¸º (500, 500 / ratio)
  ctx.drawImage(img, 1400, 0, 1400, 1400 / ratio, 0, 0, 700, 700 / ratio)
})
img.src = './car.jpeg'
```

<iframe src="https://lastknightcoder.github.io/canvas-demos/46.html" height="430" width="100%"></iframe>

`drawImage` è¿˜å¯ä»¥æ¥å— `canvas`å¯¹è±¡ä½œä¸ºå‚æ•°ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ç»˜åˆ¶ `canvas` å¯¹è±¡åœ¨ç”»å¸ƒä¸Šä¸ºå›¾ç‰‡æ·»åŠ æ°´å°

```js
const watermark = document.createElement('canvas')
const watermarkCtx = watermark.getContext('2d')
watermark.width = 120
watermark.height = 60

const text = '== ç†Šæ»” =='
watermarkCtx.fillStyle = 'rgba(204, 204, 214, 0.8)'
watermarkCtx.font = 'bold 20px æ¥·ä½“-ç®€'
watermarkCtx.fillText(text, 0, 40)

const img = new Image()
img.addEventListener('load', () => {
  const width = img.width
  const height = img.height
  const ratio = width / height
  ctx.drawImage(img, 0, 0, canvas.width, canvas.width / ratio)
  ctx.drawImage(watermark, canvas.width - watermark.width, canvas.width / ratio - watermark.height, watermark.width, watermark.height)
})
img.src = './car.jpeg'
```

<iframe src="https://lastknightcoder.github.io/canvas-demos/47.html" height="430" width="100%"></iframe>

## getImageDataã€putImageData

é€šè¿‡ `getImageData(x, y, w, h)` æ–¹æ³•å¯ä»¥è·å¾—ç”»å¸ƒæŸä¸€åŒºåŸŸçš„åƒç´ æ•°æ®ï¼Œè¿”å›çš„å¯¹è±¡ä¸­çš„ `data` å±æ€§ä¿å­˜ç€æ‰€æœ‰çš„åƒç´ ä¿¡æ¯ï¼Œå®ƒæ˜¯ä¸€ä¸ªä¸€ç»´æ•°ç»„ã€‚å› ä¸ºå¯¹äºç”»å¸ƒä¸Šçš„æ¯ä¸€åƒç´ ç‚¹éƒ½æœ‰å››ä¸ªé€šé“ï¼Œåˆ†åˆ«ä»£è¡¨ `rgba`ï¼Œ`data` æ•°ç»„ä½¿ç”¨è¿ç»­çš„å››ä¸ªå…ƒç´ è¡¨ç¤ºå››ä¸ªé€šé“çš„å€¼ï¼Œä¾‹å¦‚ `data[0]` è¡¨ç¤ºç¬¬ä¸€ä¸ªåƒç´  `r` é€šé“çš„å€¼ï¼Œ`data[1]` è¡¨ç¤º `g` é€šé“çš„å€¼ï¼Œ`data[2]` è¡¨ç¤º `b` é€šé“çš„å€¼ï¼Œ`data[3]` è¡¨ç¤º `alpha` é€šé“çš„å€¼ï¼Œ`data[4]` è¡¨ç¤ºç¬¬äºŒä¸ªåƒç´  `r` é€šé“çš„å€¼ ... ...

```js
const img = new Image()
img.addEventListener('load', () => {
  const width = img.width
  const height = img.height
  const ratio = width / height

  ctx.drawImage(img, 0, 0, 500, 500 / ratio)

  const { data } = ctx.getImageData(0, 0, 500, 500 / ratio)

  const channel = {
    red: [],
    green: [],
    blue: [],
    alpha: []
  }
  for (let  i = 0; i < data.length; i += 4) {
    channel.red.push(data[i])
    channel.green.push(data[i + 1])
    channel.blue.push(data[i + 2])
    channel.alpha.push(data[i + 3])
  }

  console.log(channel);
})

img.src = './car.jpeg'
```

<ImageView src="https://cdn.jsdelivr.net/gh/LastKnightCoder/ImgHosting3@master/Untitled.112zoco5ob1s.png" alt="Untitled" style="zoom:50%;" />

`putImage(imageData, x, y, dirtyX, dirtyY, dirtyWidth, dirtyHeight)` å¯ä»¥å°† `imageData` è¡¨ç¤ºçš„å›¾åƒé‡æ–°ç»˜åˆ¶åœ¨ Canvas ä¸­ï¼Œå…¶ä¸­ `(x, y)` è¡¨ç¤ºå›¾åƒæ”¾ç½®åœ¨ç”»å¸ƒä¸­çš„åæ ‡(å·¦ä¸Šè§’)ï¼Œ æ¥ç€å°†å›¾åƒä¸­ `(dirtyX, dirtyY, dirtyWidth, dirtyHeight)` è¡¨ç¤ºçš„çŸ©å½¢åŒºåŸŸæ˜¾ç¤ºåœ¨ç”»å¸ƒä¸­

<ImageView src="https://cdn.jsdelivr.net/gh/LastKnightCoder/ImgHosting3@master/imagedata.3i5kifc1n9u0.svg" alt="imagedata.svg"  />

```js
ctx.fillStyle='#E2C17C';
ctx.fillRect(0, 0, 300, 200)

ctx.fillStyle = '#FC7930'
ctx.fillRect(100, 100, 200, 100)

const imageData = ctx.getImageData(0, 0, 300, 200)

ctx.putImageData(imageData, 300, 200, 100, 100, 200, 100)
```

<iframe src="https://lastknightcoder.github.io/canvas-demos/49.html" height="280" width="100%"></iframe>

## æ»¤é•œ

æœ‰äº†è¯»å–åƒç´ æ•°æ®çš„èƒ½åŠ›ï¼Œæˆ‘ä»¬ä¾¿å¯ä»¥å¯¹å›¾åƒè¿›è¡Œåƒç´ çº§çš„æ“çºµï¼Œä¾‹å¦‚ä¸ºå…¶æ·»åŠ æ»¤é•œï¼Œä¸‹é¢æ¼”ç¤ºå‡ ä¸ªä¾‹å­ã€‚

ç°åº¦æ»¤é•œï¼šæ ¹æ®å›¾åƒå­¦çš„çŸ¥è¯†ï¼Œå°† `rgb` ä¸‰ä¸ªé€šé“çš„å€¼åŒæ—¶è®¾ç½®ä¸º `0.3r + 0.59g + 0.11b` å³å¯å¾—åˆ°ä¸€å¹…ç°åº¦å›¾åƒ

```js
const img = new Image()
img.addEventListener('load', () => {
  const width = img.width
  const height = img.height
  const ratio = width / height
  ctx.drawImage(img, 0, 0, canvas.width, canvas.width / ratio)

  const imageData = ctx.getImageData(0, 0, canvas.width, canvas.width / ratio)
  const { data } = imageData

  for (let i = 0; i < data.length; i += 4) {
    const gray = 0.3 * data[i] + 0.59 * data[i + 1] + 0.11 * data[i + 2]
    data[i] = gray
    data[i + 1] = gray
    data[i + 2] = gray
  }

  ctx.putImageData(imageData, 0, 0)
})
img.src = './car.jpeg'
```

<iframe src="https://lastknightcoder.github.io/canvas-demos/50.html" height="430" width="100%"></iframe>


é»‘ç™½æ»¤é•œï¼šåœ¨æ±‚å¾—ç°åº¦å€¼çš„åŸºç¡€ä¸Šï¼Œç°åº¦å€¼å¤§äºæŒ‡å®šé˜ˆå€¼çš„åƒç´ å€¼è®¾ç½®ä¸º 255ï¼Œå¦åˆ™è®¾ç½®ä¸º 0

```js
for (let i = 0; i < data.length; i += 4) {
  const gray = 0.3 * data[i] + 0.59 * data[i + 1] + 0.11 * data[i + 2]
  if (gray > 255 / 2) {
    data[i] = 255
    data[i + 1] = 255
    data[i + 2] = 255
  } else {
    data[i] = 0
    data[i + 1] = 0
    data[i + 2] = 0
  }
}
```

<iframe src="https://lastknightcoder.github.io/canvas-demos/51.html" height="430" width="100%"></iframe>

åè½¬æ»¤é•œï¼šå¯¹äº `rgb` ä¸‰ä¸ªé€šé“ï¼Œå…¶å€¼è®¾ç½®ä¸º 255 å‡å»å½“å‰é€šé“å€¼ï¼Œå¯ä»¥å¾—åˆ°åº•ç‰‡é£æ ¼çš„æ»¤é•œ

```js
for (let i = 0; i < data.length; i += 4) {
  data[i] = 255 - data[i]
  data[i + 1] = 255 - data[i + 1]
  data[i + 2] = 255 - data[i + 2]  
}
```

<iframe src="https://lastknightcoder.github.io/canvas-demos/52.html" height="430" width="100%"></iframe>

æ¨¡ç³Šæ»¤é•œï¼šå½“å‰ç‚¹åƒç´ å€¼ä¸ºå‘¨å›´å‡ ä¸ªç‚¹åƒç´ å€¼çš„å¹³å‡å€¼ï¼Œä¾‹å¦‚å‘¨å›´ 8 ä¸ªç‚¹çš„å¹³å‡å€¼

```js
const imageData = ctx.getImageData(0, 0, canvas.width, canvas.width / ratio)
const { data } = imageData
const originalData = [...data]

for (let i = 1; i < canvas.width / ratio - 1; i++) {
	for (let j = 1; j < canvas.width - 1; j++) {
	  let sr = 0
	  let sg = 0
	  let sb = 0
	  for (let m = i - 1; m <= i + 1; m++) {
	    for (let n = j - 1; n <= j + 1; n++) {
	      const p = m * canvas.width + n
	      sr += originalData[p * 4 + 0]
	      sg += originalData[p * 4 + 1]
	      sb += originalData[p * 4 + 2]
	    }
	  }
	  const p = i * canvas.width + j
	  data[p * 4 + 0] = sr / 9
	  data[p * 4 + 1] = sg / 9
	  data[p * 4 + 2] = sb / 9
	}
}
```

<iframe src="https://lastknightcoder.github.io/canvas-demos/53.html" height="430" width="100%"></iframe>

ä¸Šé¢æˆ‘ä»¬å–äº†å‘¨å›´ä¸€å±‚çš„ç‚¹ï¼Œå–çš„ç‚¹è¶Šå¤šï¼Œæ¨¡ç³Šæ•ˆæœè¶Šå¼ºï¼Œæˆ‘ä»¬å¯ä»¥å®šä¹‰æ¨¡ç³ŠåŠå¾„ï¼Œè¡¨ç¤ºå–å‘¨å›´å¤šå°‘å±‚çš„ç‚¹ï¼Œä¾‹å¦‚ä¸Šé¢å–å‘¨å›´ä¸€å±‚çš„ç‚¹ï¼Œæ¨¡ç³ŠåŠå¾„å°±ä¸º 1

```js
const blurRadius = 3
const area = (2 * blurRadius + 1) * (2 * blurRadius + 1)
for (let i = blurRadius; i < canvas.width / ratio - blurRadius; i++) {
  for (let j = blurRadius; j < canvas.width - blurRadius; j++) {
    let sr = 0, sg = 0, sb = 0
    for (let m = i - blurRadius; m <= i + blurRadius; m++) {
      for (let n = j - blurRadius; n <= j + blurRadius; n++) {
        const p = m * canvas.width + n
        sr += originalData[p * 4 + 0]
        sg += originalData[p * 4 + 1]
        sb += originalData[p * 4 + 2]
      }
    }

    const p = i * canvas.width + j    
    data[p * 4 + 0] = sr / area
    data[p * 4 + 1] = sg / area
    data[p * 4 + 2] = sb / area
  }
}
```

<iframe src="https://lastknightcoder.github.io/canvas-demos/54.html" height="430" width="100%"></iframe>

é©¬èµ›å…‹ï¼šä¸Šé¢æ¨¡ç³Šæ»¤é•œæ˜¯æŒ‡å½“å‰åƒç´ å–å‘¨å›´åŒºåŸŸåƒç´ çš„å¹³å‡å€¼ï¼Œè€Œé©¬èµ›å…‹æ˜¯æŸä¸ªåŒºåŸŸçš„æ‰€æœ‰åƒç´ å–è¯¥åŒºåŸŸåƒç´ çš„å¹³å‡å€¼ï¼ŒåŒä¸ŠåŒºåŸŸçš„å¤§å°å¯ä»¥ä½¿ç”¨ä¸€ä¸ªå˜é‡è¿›è¡Œæ§åˆ¶

```js
const size = 14
const area = size * size
for (let i = 0; i < canvas.width / ratio; i += size) {
  for (let j = 0; j < canvas.width; j += size) {
    let sr = 0, sg = 0, sb = 0
    for (let m = i; m < i + size; m++) {
      for (let n = j; n < j + size; n++) {
        const p = m * canvas.width + n
        sr += originalData[p * 4 + 0]
        sg += originalData[p * 4 + 1]
        sb += originalData[p * 4 + 2]
      }
    }
    sr = sr / area
    sg = sg / area
    sb = sb / area
    for (let m = i; m < i + size; m++) {
      for (let n = j; n < j + size; n++) {
        const p = m * canvas.width + n
        data[p * 4 + 0] = sr
        data[p * 4 + 1] = sg
        data[p * 4 + 2] = sb
      }
    }
  }
}
```

<iframe src="https://lastknightcoder.github.io/canvas-demos/55.html" height="430" width="100%"></iframe>

## createImageData

é™¤äº†é€šè¿‡ `getImageData` ä»ç”»å¸ƒä¸­æ‹¿åˆ°æ•°æ®ï¼Œè¿˜å¯ä»¥é€šè¿‡ `createImageData(width, height)` åˆ›å»º `ImageData`ï¼Œæ¥å— `width` å’Œ `height` åˆ†åˆ«ä»£è¡¨åˆ›å»ºçš„å›¾åƒçš„å®½å’Œé«˜ï¼Œé»˜è®¤æ‰€æœ‰åƒç´ çš„å››ä¸ªé€šé“çš„å€¼éƒ½ä¸º 0

```js
const imageData = ctx.createImageData(100, 100)
const { data } = imageData

for (let i = 3; i < data.length; i += 4) {
  // é€æ˜åº¦é€šé“
  data[i] = 127
}

ctx.putImageData(imageData, 0, 0, 0, 0, 100, 100)
```

<iframe src="https://lastknightcoder.github.io/canvas-demos/56.html" height="150" width="100%"></iframe>

## toDataURL

é€šè¿‡ `canvas` å¯¹è±¡çš„ `toDataURL(type)` æ–¹æ³•ï¼Œå¯ä»¥å°†ç”»å¸ƒè½¬åŒ–ä¸ºå›¾ç‰‡ï¼Œå…¶ä¸­ `type` æŒ‡å®šå›¾ç‰‡çš„ç±»å‹ï¼Œé»˜è®¤ä¸º `image/png`

```js
ctx.fillRect(0, 0, 200, 100)

const canvasToPNG = canvas => {
  return new Promise(resolve => {
    const img = new Image()
    img.addEventListener('load', () => {
      resolve(img)
    })
    img.src = canvas.toDataURL('image/png')
  })
}

canvasToImage(canvas).then(img => {
  document.body.appendChild(img)
})
```

<iframe src="https://lastknightcoder.github.io/canvas-demos/57.html" height="250" width="100%"></iframe>

å½“ `toDataURL` çš„ä¸€ä¸ªå‚æ•° `image/jpeg` `image/webp` ç­‰å¯å‹ç¼©çš„å›¾ç‰‡æ—¶ï¼Œå¯ä»¥ä¼ å…¥ç¬¬äºŒä¸ªæ•°å­—å‚æ•°è¡¨ç¤ºå‹ç¼©çš„è´¨é‡ï¼Œè´¨é‡ä½äº `0-1` ä¹‹é—´ï¼Œå½“ä¸ä¼ å…¥æ—¶ï¼Œé»˜è®¤å€¼ä¸º **0.92**

```js
canvas.toDataURL('image/jpeg', 0.8)
```

ä¸‹é¢ç»™å‡ºå°† Canvas è½¬åŒ–ä¸ºå›¾ç‰‡å¹¶è¿›è¡Œä¸‹è½½çš„ä»£ç 

```js
const downLoadCanvas = (canvas, filename = 'download') => {
  const a = document.createElement('a')
  a.download = `${filename}.png`
  a.href = canvas.toDataURL('image/png')
  a.click()
}
```

## toBlob

é€šè¿‡`toBlob(callback, type, quality)` æ–¹æ³•å¯ä»¥å°† `canvas` å¯¹è±¡è½¬åŒ–ä¸º ***Blob*** å¯¹è±¡ï¼Œè¯¥æ–¹æ³•æ¥æ”¶ä¸‰ä¸ªå‚æ•°ï¼Œç¬¬ä¸€ä¸ªå‚æ•°ä¸ºå›è°ƒå‡½æ•°ï¼Œ***Blob*** å¯¹è±¡ä¼šä½œä¸ºå‚æ•°ä¼ é€’ç»™æ”¹å‡½æ•°ï¼Œ`type` æŒ‡å®šè½¬æ¢çš„å›¾ç‰‡ç±»å‹ï¼Œå¯ä»¥ä¸º `image/png image/jpeg image.webp` ï¼Œå¯ä»¥é€šè¿‡ç¬¬ä¸‰ä¸ªå‚æ•° `quality` æŒ‡å®šå›¾ç‰‡çš„è´¨é‡ï¼Œé»˜è®¤å€¼ä¸º **0.92**

```js
const canvasToBlob = (canvas) => {
  return new Promise(resolve => {
    canvas.toBlob(blob => {
      resolve(blob)
    }, 'image/png')
  })
}

(async () => {
  const blob = await canvasToBlob(canvas)
  const url = URL.createObjectURL(blob)
  const img = new Image()
  img.src = url
  document.body.appendChild(img)
})()
```
