---
title: 多表查询
time: 2019-10-20
category: MySQL
author: 熊滔
---

多表查询顾名思义就是同时查询多张表，假设有下面这么两张表(第一张是职员(emp)表，第二张是部门(dept)表)

<img src="https://gitee.com/lastknightcoder/blogimage/raw/master/img/mysql35.png" />
<img src="https://gitee.com/lastknightcoder/blogimage/raw/master/img/mysql36.png" />

现在我们同时查询这两张表

```sql
SELECT
    *
FROM
    emp, dept;
```

我们将得到下面这么一张表

<center>
<img src="https://gitee.com/lastknightcoder/blogimage/raw/master/img/mysql37.png" />
</center>

这张表的结果是两张表一一组合得到的，得到的结果也叫做笛卡尔积，我们可以看到很有的信息都是错误的，我们的目的就是去除这些无用的信息。

### 内连接

用左边表的记录去匹配右边表的记录，如果符合条件的则显示。内连接分为

- 隐式内连接
  - 使用 `WHERE` 条件指定
- 显示内连接
  - 使用 `INNER JOIN ... ON` 语句

比如现在我要在上面的笛卡尔积中筛选出 emp 表外键 dept_id 等于主表主键 id 的，那么分别使用隐式内连接和显式外连接的写法为

```sql
#隐式写法
SELECT
    *
FROM
    emp, dept
WHERE
    emp.dept_id = dept.id;
    
#显式写法
SELECT * FROM emp INNER JOIN dept ON emp.dept_id = dept.id;
```

### 外连接

为了演示外连接，在上面的部门表中新加入一个销售部

<center>
<img src="https://gitee.com/lastknightcoder/blogimage/raw/master/img/mysql38.png" />
</center>

外连接分为

- 左外连接
- 右外连接

两者只要掌握一种即可，因为用另一种时，将二表的顺序交换即可。那什么是左外连接，就是在内连接的基础上，以左表为基准，显示左表的所有内容，如果右表没有对应的内容，那么显示为 `NULL`，现在我们进行一次内连接查询

```sql
SELECT * FROM dept INNER JOIN emp e ON e.dept_id = dept.id; # e是emp的别名
```

<center>
<img src="https://gitee.com/lastknightcoder/blogimage/raw/master/img/mysql39.png" />
</center>

现在我们进行一次左外连接查询

```sql
SELECT * FROM dept LEFT JOIN emp e ON dept.id = e.dept_id;
```

因为左外连接查询是以左表(dept)为基准，左表的内容会全部显示出来，即销售部会被查询出来，而对应的员工表没有对应的元素，所以会显示空

<center>
<img src="https://gitee.com/lastknightcoder/blogimage/raw/master/img/mysql40.png" />
</center>

而右外连接与左外连接相反，是以右表为基准，现在如果我们将二表的位置交换，并且使用右外连接查询，得到的结果与上面的会是相同的

```sql
SELECT * FROM emp e RIGHT JOIN dept d ON e.dept_id = d.id;
```

<center>
<img src="https://gitee.com/lastknightcoder/blogimage/raw/master/img/mysql41.png" />
</center>

### 子查询

所谓的子查询是指将查询得到的结果作为另一个查询语句的条件，比如我想查出薪资最高员工的信息，那么思路如下

- 查出最高的薪资是多少
- 匹配谁的薪资为最高薪资

那么第一步查出的最高薪资就作为了第二步进行匹配的条件

```sql
SELECT * FROM emp t1 WHERE t1.salary = (SELECT max(salary) FROM emp);
```

<center>
<img src="https://gitee.com/lastknightcoder/blogimage/raw/master/img/mysql42.png" />
</center>

子查询得到的结果有多种，例如

- 单行单列
- 单列多行
- 多行多列的值(表)

当结果是单个列的值的时候，肯定在 `WHERE` 后面作为条件，父查询使用比较运算符，如：`> 、<、<>、 =` 等。现在我要查询小于平均薪资的人有哪些，那么可以这么写

```sql
SELECT * FROM emp t1 WHERE t1.salary < (SELECT avg(salary) FROM emp);
```

<center>
<img src="https://gitee.com/lastknightcoder/blogimage/raw/master/img/mysql43.png" />
</center>

子查询结果是单列多行，结果集类似于一个数组，父查询使用 IN 运算符。查询工资大于5000的员工，来自于哪些部门

```sql
SELECT
    t1.name
FROM
     dept t1
WHERE
    t1.id IN (SELECT emp.dept_id FROM emp WHERE emp.salary > 5000);
```

<center>
<img src="https://gitee.com/lastknightcoder/blogimage/raw/master/img/mysql44.png" />
</center>

子查询结果只要是多列，肯定在FROM后面作为表

```sql
SELECT 查询字段 FROM （子查询）表别名 WHERE 条件;
```

子查询作为表需要取别名，否则这张表没有名称则无法访问表中的字段。查询出2011年以后入职的员工信息，包括部门名称 

```sql
SELECT
    *
FROM
    (SELECT * FROM db1.emp t1 WHERE t1.join_date > "2011-1-1") t3, dept d
WHERE
    d.id = t3.dept_id;
```