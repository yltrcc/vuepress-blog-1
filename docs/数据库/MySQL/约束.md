---
title: 约束
time: 2019-10-20
category: MySQL
author: 熊滔
commentid: mysql:yueshu
---

所谓约束就是对数据产生限制，比如说某列不能为空(NULL)，有或者说某列的数据不能重复。约束一般包括下面四种约束

- 非空约束(not null)
- 唯一约束(unique)
- 主键约束(primary key)
- 外键约束(foreign key)

### 非空约束

所谓的非空约束指的就是该列不能有 `NULL` 值，下面介绍如何创建非空约束，分为两种情况，一种是在创建表示添加非空约束，一种是在创建表之后添加非空约束

1. 创建表示添加非空约束

```sql
CREATE TABLE emp(
    id int,
    name varchar(10) not null); -- 为name添加非空约束 name不能为NULL
```

如果此时为 name 赋值为 `NULL`，那么这条语句将会报错

```sql
INSERT INTO emp(id,name) VALUES (0,NULL); -- 为name赋值为NULL 将会报错
```

```sql
Column 'name' cannot be null
```

2. 在创建表后添加非空约束

如现在给 id 也添加非空约束，应当这么写

```sql
ALTER TABLE emp MODIFY id int not null; -- 为id添加非空约束
```

3. 删除非空约束

删除的办法与添加的语法差不多，如现在我又要删除 id 的非空约束，应当这么写

```sql
ALTER TABLE emp MODIFY id int; -- 删除id的非空约束
```

### 唯一约束

唯一约束指的是该列的值不能相同，关键字为 `unique`。

1. 创建表时如何添加唯一约束

```sql
CREATE TABLE emp(
    id int UNIQUE,
    name varchar(10)); -- 为name添加非空约束 name不能为NULL
```

2. 创建表后添加唯一约束

```sql
ALTER TABLE emp MODIFY id int UNIQUE;
```

3. 删除唯一约束

删除唯一约束的语法与删除非空约束的语法不同，如下

```sql
ALTER TABLE emp DROP INDEX id;
```

### 主键约束

主键约束`(primary key)`是上面两个的总和，即该列既不能为 `NULL`，也不能相同。一张表只能有一个字段为主键。

1. 创建表时添加主键

```sql
CREATE TABLE emp(
    id int PRIMARY KEY,
    name varchar(10)); 
```

2. 创建表后添加主键

```sql
ALTER TABLE emp MODIFY id int PRIMARY KEY;
```

3. 删除主键

```sql
ALTER TABLE emp DROP PRIMARY KEY ; -- 因为主键只有一个，不必指明是哪个字段
```

下面介绍一个小知识点，主键自动增长，当我们添加数据时，如果我们设置了主键增长并且没有为主键赋值，那么主键的值会相较于上一条数据主键的值增长，设置主键自动增长的语法为(假设设置(了) id 为主键)

```sql
CREATE TABLE emp(
    id int PRIMARY KEY AUTO_INCREMENT, -- 创建表时添加
    name varchar(10) ); 

ALTER TABLE emp MODIFY id int AUTO_INCREMENT; -- 创建表后添加 id已经设置为主键了
```

删除主键增长的方法为

```sql
ALTER TABLE emp MODIFY id int; -- 这样是不会删除主键的，只会删除主键自动增长
```

### 外键约束

假设有这么一张表

<img src="https://gitee.com/lastknightcoder/blogimage/raw/master/img/mysql27.png" />

观察研发部门和部门地点，发现数据冗余很严重，并且在后续添加数据中添加的也是这么一对一对的，很麻烦并且有在添加数据可能会出错，所以我们可以把这张表拆成两张表，如下

<img src="https://gitee.com/lastknightcoder/blogimage/raw/master/img/mysql30.png" />

现在问题是怎么将这两张表联系起来，答案就是外键约束。那么什么是外键，从表(被别人约束的表)中与主表(用来约束别人的表)主键对应的那一列，如：员工表中的 dep_id。

1. 新建表时增加外键

```sql
[CONSTRAINT] [外键约束名称] FOREIGN KEY(外键字段名) REFERENCES 主表名(主键字段名)
```

2. 创建表后添加外键

```sql
ALTER TABLE 从表 ADD [CONSTRAINT] [外键约束名称] FOREIGN KEY (外键字段名) REFERENCES  主表(主
键字段名);
```

比如我在创建 employee 表时添加外键

```sql
CREATE TABLE employee(
    id INT PRIMARY KEY AUTO_INCREMENT,
    name VARCHAR(20),
    age INT,
    dep_id INT,  --  外键对应主表的主键
    CONSTRAINT emp_depid_fk FOREIGN KEY (dep_id) REFERENCES department(id)
);
```

employee 表已经存在的情况下添加外键

```sql
ALTER TABLE employee ADD CONSTRAINT emp_depid_fk FOREIGN KEY (dep_id) REFERENCES department(id);

```

3. 删除外键

```sql
--  删除 employee 表的 emp_depid_fk 外键
ALTER TABLE employee DROP FOREIGN KEY emp_depid_fk;

```

这个时候又会出现新的问题，比如我改变主表中 id=1 为 id=5，但是这时是不会成功的，因为如果改了，从表中的 dep_id 便没有对应的值，这个时候就需要级联操作(在修改和删除主表的主键时，同时更新或删除副表的外键值，称为级联操作)。

- `ON UPDATE CASCADE` 
  - 级联更新，只能是创建表的时候创建级联关系。更新主表中的主键，从表中的外键
    列也自动同步更新
- `ON DELETE CASCADE`
  - 级联删除

```sql
create table employee(
    id int primary key auto_increment,
    name varchar(20),
    age int,
    dep_id int,  --  外键对应主表的主键
    --  创建外键约束
    constraint emp_depid_fk foreign key (dep_id) references department(id) on update cascade on delete cascade
);
```